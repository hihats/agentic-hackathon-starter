# バックエンドログ機能 - 仕様書

## 1. 概要

Goバックエンドにログ出力機能を追加し、リクエスト/レスポンス、エラー、シャッフル操作を記録する。

---

## 2. 機能要件

### 2.1 ログレベル

| レベル | 用途 | 例 |
|--------|------|-----|
| DEBUG | 開発時の詳細情報 | リクエストボディの内容、アルゴリズムの途中経過 |
| INFO | 通常の操作記録 | リクエスト受信、シャッフル完了 |
| WARN | 警告（処理は継続） | 非推奨パラメータの使用 |
| ERROR | エラー発生時 | バリデーションエラー、内部エラー |

### 2.2 ログ対象

#### リクエストログ
- HTTPメソッド
- リクエストパス
- クライアントIPアドレス
- リクエストID（UUID v4）
- タイムスタンプ
- User-Agent

#### レスポンスログ
- HTTPステータスコード
- レスポンスサイズ（バイト）
- 処理時間（ミリ秒）

#### シャッフル操作ログ
- 参加者数
- グループサイズ設定
- グループ数設定
- 結果グループ数
- 操作時間

#### エラーログ
- エラーコード
- エラーメッセージ
- バリデーションエラーの詳細
- スタックトレース（ERROR レベルのみ）

---

## 3. ログフォーマット

### 3.1 JSON形式（本番環境推奨）

```json
{
  "timestamp": "2024-01-01T12:00:00.000Z",
  "level": "INFO",
  "request_id": "550e8400-e29b-41d4-a716-446655440000",
  "method": "POST",
  "path": "/api/shuffle",
  "client_ip": "192.168.1.1",
  "status": 200,
  "latency_ms": 5,
  "message": "Shuffle completed",
  "details": {
    "participants_count": 10,
    "group_size": 3,
    "groups_count": 4
  }
}
```

### 3.2 テキスト形式（開発環境用）

```
2024-01-01T12:00:00.000Z INFO [550e8400] POST /api/shuffle 200 5ms - Shuffle completed
```

---

## 4. 設定項目

### 4.1 環境変数

| 変数名 | 説明 | デフォルト値 | 有効値 |
|--------|------|-------------|--------|
| `LOG_LEVEL` | ログ出力レベル | `INFO` | `DEBUG`, `INFO`, `WARN`, `ERROR` |
| `LOG_FORMAT` | 出力フォーマット | `json` | `json`, `text` |

### 4.2 出力先

- 標準出力（stdout）へ出力
- Docker環境でのログ収集に対応

---

## 5. リクエストID

### 5.1 生成ルール
- UUID v4形式で生成
- リクエストごとに一意

### 5.2 伝播
- リクエストヘッダー `X-Request-ID` があれば使用
- なければ新規生成
- レスポンスヘッダーに `X-Request-ID` を付与

---

## 6. パフォーマンス要件

- ログ出力によるレイテンシ増加: 1ms以下
- 非同期書き込みは不要（stdoutへの直接出力）
- バッファリングはGoランタイムに委任

---

## 7. セキュリティ考慮事項

- 参加者の名前はDEBUGレベルでのみ出力
- 個人情報を含むフィールドはマスキング対象外（現仕様では名前のみ）
- リクエストボディの完全な出力はDEBUGレベルに限定
